---
title: "TVMVP: Overview and Getting Started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{TVMVP: Overview and Getting Started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Time-Varying Minimum Variance Portfolio (TVMVP)
The TVMVP package implements a method for estimating a time-dependent covariance matrix based on time series data using principal component analysis on kernel-weighted data. It also includes:

\begin{itemize}
\item A BIC-type information criterion for determining the optimal number of factors
\item A hypothesis test for time-invariant covariance
\item Rolling-window evaluation of portfolio
\item Multiple portfolio optimization texhniques
\end{itemize}

## Example
```{r}
library(TVMVP)
```

### Simulate data
For this example we will us simulated data, however most use cases for this package will be using financial data. This can be accessed using one of the many API’s available in R and elsewhere
```{r}
set.seed(123)
uT <- 100  # Number of time periods
up <- 20   # Number of assets
returns <- matrix(rnorm(uT * up, mean = 0.001, sd = 0.02), ncol = up)
```

## Determine optimal number of factors and run hypothesis test
```{r}
m <- determine_factors(returns = returns, max_m = 10, bandwidth = silverman(returns))$optimal_m
m
hypothesis_test <- hyptest1(returns = returns,
                            m = m,
                            B = 10, # Use larger B in practice
                            kernel_func = epanechnikov_kernel)
```

The function `determine_factors` uses a BIC-type information criterion in order to determine the optimal number of factors to be used in the model. More information can be seen in section 2.2 of the thesis. The input variables are the data matrix `returns`, the max number of factors to be tested `max_m`, and the bandwidth to be used `bandwidth`. The package offers the functionality of computing the bandwidth using Silverman’s rule of thumb with the function `silverman()`, however other methods could be used. The function outputs the optimal number of factors `optimal_m`, and the values of the information criteria for the different number of factors `IC_values`.

`hyptest1` implements the hypothesis test of constant factor loadings introduced by Su & Wong (2017). Under some conditions, the test statistic $J$ follows a standard normal distribution under the null. However, the test have been proven to be somewhat unreliable in finite sample usage, which is why the option of computing a bootstrap p-value is included. More information can be found in section 2.3 in the thesis. The function take the input: a data matrix of multiple time series `returns`, the number of factors `m`, the number of bootstrap replications `B`, and the kernel function `kernel_func.` The package offers the Epanechnikov kernel, however others could also be used.

## Portfolio optimization

The package offers two functions for the purpose of portfolio estimation and evaluation: `rolling_time_varying_mvp` which implements a rolling window in order to evaluate the performance of a minimum variance portfolio implemented using the time-varying covariance matrix, and `predict_portfolio` which implements an out of sample prediction of the portfolio.

Note that these functions expect log returns and log risk free rates. 

```{r}
mvp_result <- rolling_time_varying_mvp(
  returns        = returns,
  initial_window = 60,
  rebal_period   = 5,
  max_factors    = 10,
  return_type    = "daily",
  kernel_func    = epanechnikov_kernel,
  rf             = 1e-04
)
mvp_result
```

The `rolling_time_varying_mvp` function takes the input: `returns` a $T\times p$ data matrix of log returns, `initial_window` which is the initial holding window used for estimation, `rebal_period` which is the length of the rebalancing period to be used in the evaluation, `max_factors` used in the determination of the optimal number of factors, `return_type` can be set to “daily”, “weekly”, and “monthly”, and is used for annualization of the results, `kernel_func`, and `rf` which denotes the risk free rate, this can be input either as a scalar or at $(T-initial\_window)\times1$ numerical vector. The function outputs relevant metrics for evaluation of the performance of the portfolio such as cumulative log excess returns, standard deviation, and Sharpe ratio.

```{r}
prediction <- predict_portfolio(returns = returns, 
                                horizon = 21, 
                                max_factors = 10,
                                kernel_func = epanechnikov_kernel,
                                min_return=0.5,
                                max_SR = TRUE,
                                rf = 1e-04)
prediction
```

The `predict_portfolio` functions makes out of sample predictions of the portfolio performance. The functions offers three different methods of portfolio optimization: Minimum variance, Minimum variance with minimum returns constraint, and maximum Sharpe ratio portfolio. The minimum variance portfolio is the default portfolio and will always be computed when running this function. The minimum returns constraint is set by imputing some `min_return`-value when running the function, important to note is that the minimum return constraint is set for the entire horizon and is not a daily constraint. The maximum SR portfolio is computed when `max_SR` is set to `TRUE`.

## Covariance matrix estimation

If the pre-built functions does not fit your purpose, you can utilize the covariance function by running:

```{r}
cov_mat <- time_varying_cov(returns,
                            m,
                            bandwidth = silverman(returns),
                            kernel_func = epanechnikov_kernel,
                            M0 = 10,
                            rho_grid = seq(0.005, 2, length.out = 30),
                            floor_value = 1e-12,
                            epsilon2 = 1e-6,
                            full_output = FALSE)
  
```
Which outputs the covariance matrix weighted around the last observation in returns. 

## References

\begin{itemize}
\item Su, L., & Wang, X. (2017). On time-varying factor models: Estimation and testing. \emph{Journal of Econometrics}, 198(1), 84–101.
\item Lillrank, E. (2025). Time-Varying Minimum Variance Portfolio.
\end{itemize}
